name: qemu-minimal-smoke-test

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    paths:
    - 'qemu/*-vm'

jobs:

  smoke-test-x86:
    name: smoke-test-x86
    runs-on: ubuntu-latest
    steps:
    - name: Check out code using action/checkout
      uses: actions/checkout@v4.2.2
    - name: Install a couple of packages via the apt package manager
      run: |
        sudo apt update
        sudo apt install -y qemu-system-x86 qemu-utils cloud-image-utils
    - name: Generate an ssh key-pair for this test
      run: ssh-keygen -t rsa -q -f "$HOME/.ssh/id_rsa" -N ""
    - name: Generate a x86_64 qemu-based ./gen-vm smoke-test
      run: ./gen-vm
      working-directory: qemu
      env:
        VM_NAME: qemu-minimal-smoke-test
        KVM: none
        USERNAME: ubuntu
        PASS: password
    - name: Test RESTORE_IMAGE mode
      run: |
        # Remove the main image to simulate corruption/deletion
        rm -f ../images/qemu-minimal-smoke-test.qcow2
        # Verify it was removed
        if [ -f ../images/qemu-minimal-smoke-test.qcow2 ]; then
          echo "Failed to remove image for test"
          exit 1
        fi
        # Restore from backing file using RESTORE_IMAGE mode
        VM_NAME=qemu-minimal-smoke-test \
          RESTORE_IMAGE=true \
          ./gen-vm
        # Verify the image was recreated with backing file
        if [ ! -f ../images/qemu-minimal-smoke-test.qcow2 ]; then
          echo "Image not restored from backing"
          exit 1
        fi
        if ! qemu-img info ../images/qemu-minimal-smoke-test.qcow2 \
             | grep -q "backing file:"; then
          echo "Restored image does not have backing file"
          exit 1
        fi
        echo "✓ RESTORE_IMAGE mode test passed"
      working-directory: qemu
    - name: Test NVME_TRACE mode
      run: |
        # Start VM with NVMe trace enabled, run for 3 seconds
        timeout 3 ./run-vm > /dev/null 2>&1 || true
        # Check if trace file was created and contains doorbell traces
        if [ ! -f /tmp/nvme-trace.log ]; then
          echo "Trace file not created"
          exit 1
        fi
        if ! grep -q "pci_nvme_mmio_doorbell" /tmp/nvme-trace.log; then
          echo "No doorbell traces found in output"
          cat /tmp/nvme-trace.log
          exit 1
        fi
        echo "✓ NVME_TRACE mode test passed"
        # Clean up trace file
        rm -f /tmp/nvme-trace.log
      working-directory: qemu
      env:
        VM_NAME: qemu-minimal-smoke-test
        KVM: none
        NVME: 1
        NVME_TRACE: doorbell
        NVME_TRACE_FILE: /tmp/nvme-trace.log
    - name: Run the generated x86_64 VM as a background task
      run: ./run-vm > run-vm-output.log 2>&1 &
      working-directory: qemu
      env:
        VM_NAME: qemu-minimal-smoke-test
        KVM: none
        NVME: 4
    - name: Wait for VM to boot (smart polling with 60s timeout)
      run: |
        echo "Waiting for VM to boot and accept SSH connections..."
        timeout=60
        elapsed=0
        while [ $elapsed -lt $timeout ]; do
          if ssh -o ConnectTimeout=1 \
                 -o NoHostAuthenticationForLocalhost=yes \
                 -o StrictHostKeyChecking=no \
                 -p 2222 ubuntu@localhost true 2>/dev/null; then
            echo "✓ VM ready after $elapsed seconds"
            exit 0
          fi
          sleep 2
          elapsed=$((elapsed + 2))
        done
        echo "✗ VM failed to boot within $timeout seconds"
        exit 1
    - name: Output run-vm command output
      run: |
        cat qemu/run-vm-output.log
    - name: Make sure we can ssh into running VM
      run: |
        ssh -o NoHostAuthenticationForLocalhost=yes \
          -v -p 2222 ubuntu@localhost ls -ltrh

  smoke-test-arm64:
    name: smoke-test-arm64
    runs-on: ubuntu-latest
    steps:
    - name: Check out code using action/checkout
      uses: actions/checkout@v4.2.2
    - name: Install a couple of packages via the apt package manager
      run: |
        sudo apt update
        sudo apt install -y qemu-system-arm cloud-image-utils
    - name: Generate an ssh key-pair for this test
      run: ssh-keygen -t rsa -q -f "$HOME/.ssh/id_rsa" -N ""
    - name: Run a aarch64 qemu-based ./gen-vm smoke-test
      run: ./gen-vm
      working-directory: qemu
      env:
        VM_NAME: qemu-minimal-smoke-test-arm64
        KVM: none
        USERNAME: ubuntu
        PASS: password
        ARCH: arm64

  smoke-test-riscv64:
    name: smoke-test-riscv64
    runs-on: ubuntu-latest
    steps:
    - name: Check out code using action/checkout
      uses: actions/checkout@v4.2.2
    - name: Install a couple of packages via the apt package manager
      run: sudo apt update && sudo apt install -y qemu-system-misc u-boot-qemu cloud-image-utils
    - name: Generate an ssh key-pair for this test
      run: ssh-keygen -t rsa -q -f "$HOME/.ssh/id_rsa" -N ""
    - name: Run a riscv64 qemu-based ./gen-vm smoke-test
      run: ./gen-vm
      working-directory: qemu
      env:
        VM_NAME: qemu-minimal-smoke-test-riscv64
        KVM: none
        USERNAME: ubuntu
        PASS: password
        ARCH: riscv64
